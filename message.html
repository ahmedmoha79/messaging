    document.addEventListener('DOMContentLoaded', function() {
    const supabase = createClient('https://YOUR_PROJECT.supabase.co', 'YOUR_ANON_KEY');

    // Utility functions for session management
    function generateSessionId() {
        return Math.random().toString(36).substring(2, 15) +
               Math.random().toString(36).substring(2, 15);
        }

    function normalizeUserId(id) {
        return typeof id === 'string' && id.includes('-') ? id : id;
    }

    // Global state variables
    let currentUser = null;
    let selectedUserId = null;
    let authToken = null;
    let sessionId = localStorage.getItem('chatSessionId') || generateSessionId();
    localStorage.setItem('chatSessionId', sessionId);

    // Authentication and initialization
    function initializeChat() {
        authToken = localStorage.getItem('authToken');
        if (!authToken) {
            window.location.href = '/login.html';
            return;
        }

        currentUser = JSON.parse(localStorage.getItem('currentUser'));
        setupEventListeners();
        loadUsers();
        setupRefreshInterval();
    }

    function setupEventListeners() {
        document.getElementById('send-button').addEventListener('click', sendMessage);
        document.getElementById('message-text').addEventListener('keypress', handleMessageKeyPress);
            }

    function handleMessageKeyPress(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    }

    function setupRefreshInterval() {
        setInterval(() => {
            loadUsers();
        if (selectedUserId) {
            loadMessages(selectedUserId);
        }
        }, 10000);
    }

    // User and message management
    async function loadUsers() {
        try {
            const response = await fetch('/api/users', {
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'X-Session-ID': sessionId
                }
    });

            if (!response.ok) {
                handleUnauthorized(response);
                return;
            }

            const users = await response.json();
            updateUserList(users);
        } catch (error) {
            console.error('Error loading users:', error);
            }
        }

    function updateUserList(users) {
        const userList = document.getElementById('user-list');
        userList.innerHTML = '';

        users.forEach(user => {
            if (user.id === currentUser.id) return;

            const userElement = createUserElement(user);
            userList.appendChild(userElement);
    });

        updateOnlineCount(users);
    }

    function createUserElement(user) {
        const userDiv = document.createElement('div');
        userDiv.className = `user-item ${selectedUserId === user.id ? 'active' : ''}`;
        userDiv.dataset.userId = user.id;
        userDiv.onclick = () => selectUser(user.id, user.name);

        const userInfo = document.createElement('div');
        userInfo.className = 'user-info';
        userInfo.innerHTML = `
            <span class="user-name">${user.name || user.email.split('@')[0]}</span>
            <span class="status-indicator ${user.status === 'online' ? 'online' : 'offline'}"></span>
        `;

        userDiv.appendChild(userInfo);
        return userDiv;
    }

    function updateOnlineCount(users) {
        const onlineUsers = users.filter(user => user.status === 'online');
        document.getElementById('online-count').textContent = onlineUsers.length;
    }

    function selectUser(userId, userName) {
        selectedUserId = normalizeUserId(userId);
        updateSelectedUserUI(userName);
        loadMessages(selectedUserId);
    }

    function updateSelectedUserUI(userName) {
        document.querySelectorAll('.user-item').forEach(item => {
            item.classList.remove('active');
        });

        const selectedItem = document.querySelector(`.user-item[data-user-id="${selectedUserId}"]`);
        if (selectedItem) {
            selectedItem.classList.add('active');
        }

        document.getElementById('selected-user-name').textContent = userName || selectedUserId;
    }

    async function loadMessages(partnerId) {
        try {
            const response = await fetch(`/api/messages/${partnerId}`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'X-Session-ID': sessionId
                }
    });

            if (!response.ok) {
                throw new Error(`Failed to load messages: ${response.status}`);
            }

            const messages = await response.json();
            renderMessages(messages);
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }

    function renderMessages(messages) {
        const messageContainer = document.getElementById('message-container');
        messageContainer.innerHTML = '';

        messages.forEach(message => {
            const messageDiv = createMessageElement(message);
            messageContainer.appendChild(messageDiv);
        });

        messageContainer.scrollTop = messageContainer.scrollHeight;
    }

    function createMessageElement(message) {
        const messageDiv = document.createElement('div');
        const isSent = message.sender_id === currentUser.id;

        messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
        messageDiv.innerHTML = `
            <div class="message-content">${message.content}</div>
            <div class="message-time">${formatMessageTime(message.created_at)}</div>
        `;

        return messageDiv;
    }

    function formatMessageTime(timestamp) {
        const date = new Date(timestamp);
        return `${date.toLocaleString('default', { month: 'short' })} ${date.getDate()}, ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    }

    async function sendMessage() {
        const messageText = document.getElementById('message-text').value.trim();
        if (!messageText || !selectedUserId) return;

        try {
            const messageData = {
                sender_id: currentUser.id,
                receiver_id: selectedUserId,
                content: messageText,
                is_read: false
            };

            const response = await fetch('/api/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                    'X-Session-ID': sessionId
                },
                body: JSON.stringify(messageData)
            });

            if (!response.ok) {
                throw new Error('Failed to send message');
            }

            document.getElementById('message-text').value = '';
            loadMessages(selectedUserId);
        } catch (error) {
            console.error('Error sending message:', error);
        }
    }

    function handleUnauthorized(response) {
        if (response.status === 401) {
            localStorage.removeItem('authToken');
            window.location.href = '/login.html';
        }
    }

    // Initialize the chat application
    initializeChat();
});